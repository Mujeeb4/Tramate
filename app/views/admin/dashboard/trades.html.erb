<div class="admin-dashboard">
  <div class="admin-header">
    <h1>Trade Monitoring</h1>
    <p class="admin-subtitle">Monitor and manage all trade activities on the platform</p>
  </div>

  <div class="stats-overview">
    <div class="stat-card primary">
      <div class="stat-icon">
        <i class="admin-icon-trades"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value"><%= @total_trades %></span>
        <span class="stat-label">Total Trades</span>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">
        <i class="admin-icon-success"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value"><%= @successful_trades %></span>
        <span class="stat-label">Successful Trades</span>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">
        <i class="admin-icon-pending"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value"><%= @pending_trades %></span>
        <span class="stat-label">Pending Trades</span>
      </div>
    </div>

    <div class="stat-card danger">
      <div class="stat-icon">
        <i class="admin-icon-failed"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value"><%= @failed_trades %></span>
        <span class="stat-label">Failed Trades</span>
      </div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-section">
      <h3>Trade Volume (Last 30 Days)</h3>
      <canvas id="tradeVolumeChart" height="250"></canvas>
    </div>
    <div class="chart-section">
      <h3>Success Rate by Channel</h3>
      <canvas id="successRateChart" height="250"></canvas>
    </div>
  </div>

  <div class="admin-section">
    <div class="section-header">
      <h2>Active Trades</h2>
      <div class="filters">
        <input type="text" placeholder="Search trades..." class="search-input">
        <select class="filter-select">
          <option value="all">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
        </select>
        <div class="date-range-picker">
          <input type="date" class="date-input" placeholder="Start Date">
          <span>to</span>
          <input type="date" class="date-input" placeholder="End Date">
        </div>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Channel</th>
            <th>Trading Pair</th>
            <th>Type</th>
            <th>Entry Price</th>
            <th>Current/Exit Price</th>
            <th>Amount</th>
            <th>P/L</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @trades&.any? %>
            <% @trades.each do |trade| %>
              <tr data-trade-id="<%= trade.id %>" class="trade-row <%= trade.status %>">
                <td><%= trade.id %></td>
                <td>
                  <% if trade.respond_to?(:user) && trade.user %>
                    <div class="user-info">
                      <div class="user-avatar"><%= trade.user.email[0].upcase %></div>
                      <span><%= trade.user.email %></span>
                    </div>
                  <% else %>
                    Unknown
                  <% end %>
                </td>
                <td>
                  <% if trade.respond_to?(:channel) && trade.channel %>
                    <%= trade.channel.name %>
                  <% else %>
                    Manual
                  <% end %>
                </td>
                <td><span class="trading-pair"><%= trade.trading_pair %></span></td>
                <td>
                  <span class="trade-type <%= trade.trade_type.to_s.downcase %>">
                    <%= trade.trade_type %>
                  </span>
                </td>
                <td><%= number_with_precision(trade.entry_price, precision: 8) %></td>
                <td>
                  <% if trade.exit_price.present? %>
                    <%= number_with_precision(trade.exit_price, precision: 8) %>
                  <% else %>
                    <span class="current-price" data-symbol="<%= trade.trading_pair %>">Loading...</span>
                  <% end %>
                </td>
                <td><%= trade.amount %> <%= trade.trading_pair.split('/').first %></td>
                <td>
                  <% if trade.profit_loss.present? %>
                    <span class="<%= trade.profit_loss >= 0 ? 'profit' : 'loss' %>">
                      <%= number_with_precision(trade.profit_loss, precision: 2) %>%
                    </span>
                  <% else %>
                    <span class="calculating">Calculating...</span>
                  <% end %>
                </td>
                <td>
                  <span class="status-badge <%= trade.status.to_s.downcase %>">
                    <%= trade.status %>
                  </span>
                </td>
                <td><%= trade.created_at.strftime("%b %d, %H:%M") %></td>
                <td>
                  <div class="action-buttons">
                    <%= link_to "View Details", "#", class: "btn btn-sm btn-outline-primary",
                        data: { toggle: "modal", target: "#tradeDetailModal#{trade.id}" } %>
                    <% if trade.status == 'active' || trade.status == 'pending' %>
                      <%= link_to "Close", "#", class: "btn btn-sm btn-outline-warning close-trade-btn",
                          data: { trade_id: trade.id } %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="12" class="text-center">No trades found.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <div class="pagination-container">
      <%= paginate @trades if defined?(paginate) %>
    </div>
  </div>
  
  <!-- Trade Details Modal -->
  <% if @trades&.any? %>
    <% @trades.each do |trade| %>
      <div class="modal fade" id="tradeDetailModal<%= trade.id %>" tabindex="-1" role="dialog" aria-labelledby="tradeDetailModalLabel<%= trade.id %>" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tradeDetailModalLabel<%= trade.id %>">Trade Details #<%= trade.id %></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="trade-detail-header">
                <div class="trade-type-large <%= trade.trade_type.to_s.downcase %>">
                  <%= trade.trade_type %>
                </div>
                <div class="trade-pair-large">
                  <%= trade.trading_pair %>
                </div>
                <div class="trade-status-large">
                  <span class="status-badge <%= trade.status.to_s.downcase %>">
                    <%= trade.status %>
                  </span>
                </div>
              </div>
              
              <div class="trade-detail-grid">
                <div class="trade-detail-group">
                  <h4>Trade Information</h4>
                  <div class="detail-item">
                    <span class="detail-label">User:</span>
                    <span class="detail-value"><%= trade.user&.email || 'Unknown' %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Channel:</span>
                    <span class="detail-value"><%= trade.channel&.name || 'Manual' %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value"><%= trade.created_at.strftime("%B %d, %Y at %H:%M:%S") %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Updated:</span>
                    <span class="detail-value"><%= trade.updated_at.strftime("%B %d, %Y at %H:%M:%S") %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Exchange:</span>
                    <span class="detail-value"><%= trade.exchange || 'Binance' %></span>
                  </div>
                </div>
                
                <div class="trade-detail-group">
                  <h4>Price Information</h4>
                  <div class="detail-item">
                    <span class="detail-label">Entry Price:</span>
                    <span class="detail-value"><%= number_with_precision(trade.entry_price, precision: 8) %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Exit Price:</span>
                    <span class="detail-value">
                      <%= trade.exit_price.present? ? number_with_precision(trade.exit_price, precision: 8) : 'N/A' %>
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Stop Loss:</span>
                    <span class="detail-value">
                      <%= trade.stop_loss.present? ? number_with_precision(trade.stop_loss, precision: 8) : 'N/A' %>
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Take Profit:</span>
                    <span class="detail-value">
                      <%= trade.take_profit.present? ? number_with_precision(trade.take_profit, precision: 8) : 'N/A' %>
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value"><%= trade.amount %> <%= trade.trading_pair.split('/').first %></span>
                  </div>
                </div>
              </div>
              
              <% if trade.signal.present? %>
                <div class="trade-signal-section">
                  <h4>Signal Information</h4>
                  <div class="signal-content">
                    <pre><%= trade.signal.content %></pre>
                  </div>
                </div>
              <% end %>
              
              <% if trade.status == 'active' || trade.status == 'pending' %>
                <div class="trade-action-section">
                  <h4>Manual Actions</h4>
                  <%= form_with(url: admin_trade_update_path(trade), method: :patch, class: "admin-form") do |form| %>
                    <div class="form-group">
                      <%= form.label :status, "Change Status:" %>
                      <%= form.select :status, 
                        options_for_select([
                          ['Active', 'active'], 
                          ['Completed', 'completed'], 
                          ['Failed', 'failed'],
                          ['Cancelled', 'cancelled']
                        ], trade.status), 
                        {}, { class: "form-control" } %>
                    </div>
                    <div class="form-group">
                      <%= form.label :exit_price, "Exit Price:" %>
                      <%= form.text_field :exit_price, class: "form-control", 
                          placeholder: "Enter exit price if manually closing" %>
                    </div>
                    <div class="form-group">
                      <%= form.label :notes, "Admin Notes:" %>
                      <%= form.text_area :notes, class: "form-control", rows: 3, 
                          placeholder: "Add any notes about this trade" %>
                    </div>
                    <div class="form-actions">
                      <%= form.submit "Update Trade", class: "btn btn-primary" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Setup charts
    setupTradeVolumeChart();
    setupSuccessRateChart();
    
    // Update current prices for active trades
    updateCurrentPrices();
    
    // Close trade button functionality
    document.querySelectorAll('.close-trade-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const tradeId = this.getAttribute('data-trade-id');
        if (confirm('Are you sure you want to manually close this trade?')) {
          // Send AJAX request to close the trade
          console.log(`Closing trade ${tradeId}`);
          // Implement actual AJAX call here
        }
      });
    });
  });
  
  function setupTradeVolumeChart() {
    const ctx = document.getElementById('tradeVolumeChart').getContext('2d');
    // Sample data - replace with actual data from backend
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length: 30}, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - 29 + i);
          return d.getDate() + '/' + (d.getMonth() + 1);
        }),
        datasets: [{
          label: 'Trade Volume',
          data: Array.from({length: 30}, () => Math.floor(Math.random() * 100)),
          backgroundColor: '#00ADB5',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
  
  function setupSuccessRateChart() {
    const ctx = document.getElementById('successRateChart').getContext('2d');
    // Sample data - replace with actual data from backend
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Channel A', 'Channel B', 'Channel C', 'Channel D'],
        datasets: [{
          data: [75, 65, 82, 58],
          backgroundColor: ['#00ADB5', '#3498db', '#2ecc71', '#f39c12']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw}% success rate`;
              }
            }
          }
        }
      }
    });
  }
  
  function updateCurrentPrices() {
    // Simulate getting current prices - replace with actual API calls
    document.querySelectorAll('.current-price').forEach(element => {
      const symbol = element.getAttribute('data-symbol');
      // In a real application, you'd fetch the current price from an exchange API
      const mockPrice = (Math.random() * 50000).toFixed(2);
      setTimeout(() => {
        element.textContent = mockPrice;
      }, 500);
    });
  }
</script>

<style>
  .admin-dashboard {
    padding: 20px;
  }
  
  .stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .stat-card.primary {
    border-left: 4px solid #00ADB5;
  }
  
  .stat-card.success {
    border-left: 4px solid #2ed573;
  }
  
  .stat-card.warning {
    border-left: 4px solid #ffa502;
  }
  
  .stat-card.danger {
    border-left: 4px solid #ff4757;
  }
  
  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    background-color: rgba(0, 173, 181, 0.1);
    color: #00ADB5;
  }
  
  .stat-content {
    display: flex;
    flex-direction: column;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
  }
  
  .stat-label {
    font-size: 14px;
    color: #6c757d;
  }
  
  .chart-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .chart-section {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .chart-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 500;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filters {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .date-range-picker {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .date-input {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  
  .trade-row.active {
    background-color: rgba(0, 173, 181, 0.05);
  }
  
  .trade-row.pending {
    background-color: rgba(255, 165, 2, 0.05);
  }
  
  .trade-row.completed.profit {
    background-color: rgba(46, 213, 115, 0.05);
  }
  
  .trade-row.failed {
    background-color: rgba(255, 71, 87, 0.05);
  }
  
  .trade-type {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .trade-type.buy, .trade-type.long {
    background-color: rgba(46, 213, 115, 0.15);
    color: #2ed573;
  }
  
  .trade-type.sell, .trade-type.short {
    background-color: rgba(255, 71, 87, 0.15);
    color: #ff4757;
  }
  
  .profit {
    color: #2ed573;
    font-weight: 600;
  }
  
  .loss {
    color: #ff4757;
    font-weight: 600;
  }
  
  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .status-badge.active {
    background-color: rgba(0, 173, 181, 0.15);
    color: #00ADB5;
  }
  
  .status-badge.pending {
    background-color: rgba(255, 165, 2, 0.15);
    color: #ffa502;
  }
  
  .status-badge.completed {
    background-color: rgba(46, 213, 115, 0.15);
    color: #2ed573;
  }
  
  .status-badge.failed, .status-badge.cancelled {
    background-color: rgba(255, 71, 87, 0.15);
    color: #ff4757;
  }
  
  .user-info {
    display: flex;
    align-items: center;
  }
  
  .user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #3498db;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
  }
  
  .trading-pair {
    font-weight: 500;
  }
  
  .calculating {
    color: #6c757d;
    font-style: italic;
  }
  
  .trade-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .trade-type-large {
    font-size: 18px;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: 6px;
  }
  
  .trade-pair-large {
    font-size: 24px;
    font-weight: 600;
  }
  
  .trade-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }
  
  .trade-detail-group h4 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 16px;
    font-weight: 600;
    color: #6c757d;
  }
  
  .detail-item {
    margin-bottom: 12px;
    display: flex;
  }
  
  .detail-label {
    width: 120px;
    color: #6c757d;
    font-weight: 500;
  }
  
  .detail-value {
    font-weight: 500;
  }
  
  .trade-signal-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
  }
  
  .trade-signal-section h4 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 16px;
    font-weight: 600;
    color: #6c757d;
  }
  
  .signal-content {
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .signal-content pre {
    white-space: pre-wrap;
    font-family: monospace;
    margin: 0;
  }
  
  .trade-action-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
  }
  
  .trade-action-section h4 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 16px;
    font-weight: 600;
    color: #6c757d;
  }
  
  @media (max-width: 1200px) {
    .chart-container {
      grid-template-columns: 1fr;
    }
    
    .trade-detail-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }
</style>