<div class="admin-dashboard">
  <div class="admin-header">
    <div class="back-link">
      <%= link_to admin_users_path do %>
        <i class="fas fa-arrow-left"></i> Back to Users
      <% end %>
    </div>
    <h1>User Profile: <%= @user.full_name %></h1>
    <div class="user-type-badge">
      <span class="status-badge <%= @user.admin? ? 'admin' : 'user' %>">
        <%= @user.admin? ? 'Admin User' : 'Regular User' %>
      </span>
    </div>
  </div>

  <div class="user-details-container">
    <!-- User Information -->
    <div class="details-section">
      <div class="section-header">
        <h2>Account Information</h2>
        <div class="section-actions">
          <%= link_to edit_admin_user_path(@user), class: "btn btn-primary" do %>
            <i class="fas fa-pencil-alt"></i> Edit User
          <% end %>
          <%= button_to admin_toggle_admin_path(@user), method: :post, class: "btn #{@user.admin? ? 'btn-danger' : 'btn-success'}" do %>
            <i class="fas fa-<%= @user.admin? ? 'user-minus' : 'user-shield' %>"></i>
            <%= @user.admin? ? 'Remove Admin Status' : 'Make Admin' %>
          <% end %>
        </div>
      </div>
      
      <div class="detail-cards">
        <div class="detail-card">
          <h3>Basic Info</h3>
          <div class="detail-content">
            <div class="detail-item">
              <span class="detail-label">User ID:</span>
              <span class="detail-value"><%= @user.id %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Full Name:</span>
              <span class="detail-value"><%= @user.full_name %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value"><%= @user.email %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Registered:</span>
              <span class="detail-value"><%= @user.created_at.strftime("%B %d, %Y") %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Last Updated:</span>
              <span class="detail-value"><%= @user.updated_at.strftime("%B %d, %Y %H:%M") %></span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <h3>Subscription & Access</h3>
          <div class="detail-content">
            <div class="detail-item">
              <span class="detail-label">Status:</span>
              <span class="detail-value">
                <span class="status-badge <%= @user.subscription_status&.downcase || 'inactive' %>">
                  <%= @user.subscription_status&.capitalize || 'Inactive' %>
                </span>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Discord ID:</span>
              <span class="detail-value"><%= @user.discord_id || 'Not connected' %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Channels:</span>
              <span class="detail-value"><%= @user_channel_accesses.count %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Total Trades:</span>
              <span class="detail-value"><%= @user.trades.count %></span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <h3>API Connections</h3>
          <div class="detail-content">
            <% if @user.api_credentials.any? %>
              <% @user.api_credentials.each do |credential| %>
                <div class="api-credential">
                  <div class="detail-item">
                    <span class="detail-label">Platform:</span>
                    <span class="detail-value"><%= credential.platform %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Label:</span>
                    <span class="detail-value"><%= credential.label %></span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Status:</span>
                    <span class="status-badge <%= credential.active? ? 'active' : 'inactive' %>">
                      <%= credential.active? ? 'Active' : 'Inactive' %>
                    </span>
                  </div>
                </div>
                <% unless credential == @user.api_credentials.last %>
                  <hr class="api-divider">
                <% end %>
              <% end %>
            <% else %>
              <div class="no-data">No API credentials configured</div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Channel Access -->
    <div class="details-section">
      <h2 class="section-title">Channel Subscriptions</h2>
      
      <% if @user_channel_accesses.any? %>
        <div class="table-responsive">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Channel</th>
                <th>Access Type</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Payment</th>
              </tr>
            </thead>
            <tbody>
              <% @user_channel_accesses.each do |access| %>
                <tr>
                  <td><%= access.channel.name %></td>
                  <td><%= access.access_type %></td>
                  <td><%= access.access_start_date.strftime("%b %d, %Y") %></td>
                  <td><%= access.access_end_date.strftime("%b %d, %Y") %></td>
                  <td>
                    <% if Time.now > access.access_end_date %>
                      <span class="status-badge expired">Expired</span>
                    <% else %>
                      <span class="status-badge active">Active</span>
                    <% end %>
                  </td>
                  <td>
                    <% if access.payment %>
                      <%= link_to access.payment.payment_gateway_id, admin_payment_path(access.payment) %>
                    <% else %>
                      Manual
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="no-data">User is not subscribed to any channels</div>
      <% end %>
    </div>

    <!-- Recent Trades and Payments Tabs -->
    <div class="details-section">
      <div class="tabs-container">
        <div class="tabs">
          <div class="tab active" data-tab="recent-trades">Recent Trades</div>
          <div class="tab" data-tab="recent-payments">Recent Payments</div>
        </div>
        
        <div class="tab-content">
          <!-- Recent Trades Tab -->
          <div class="tab-pane active" id="recent-trades">
            <% if @trades.any? %>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Signal</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Amount</th>
                      <th>Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @trades.each do |trade| %>
                      <% signal = trade.signal %>
                      <% trading_pair = signal&.parsed_data&.dig('symbol') || 'N/A' %>
                      <% trade_type = signal&.parsed_data&.dig('side') || 'N/A' %>
                      
                      <tr>
                        <td><%= trade.id %></td>
                        <td><%= trading_pair %></td>
                        <td>
                          <span class="trade-type <%= trade_type.downcase if trade_type %>">
                            <%= trade_type %>
                          </span>
                        </td>
                        <td>
                          <span class="status-badge <%= trade.status.downcase if trade.status %>">
                            <%= trade.status %>
                          </span>
                        </td>
                        <td><%= trade.amount || 'N/A' %></td>
                        <td><%= trade.created_at.strftime("%b %d, %H:%M") %></td>
                        <td>
                          <%= link_to admin_trade_path(trade), class: "action-button view" do %>
                            <i class="fas fa-eye"></i>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              <div class="view-all-link">
                <%= link_to admin_trades_path(user_id: @user.id), class: "btn btn-secondary" do %>
                  View All Trades
                <% end %>
              </div>
            <% else %>
              <div class="no-data">No trades found for this user</div>
            <% end %>
          </div>
          
          <!-- Recent Payments Tab -->
          <div class="tab-pane" id="recent-payments">
            <% if @payments.any? %>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Amount</th>
                      <th>Payment ID</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @payments.each do |payment| %>
                      <tr>
                        <td><%= payment.id %></td>
                        <td><%= number_to_currency(payment.amount) %></td>
                        <td><%= payment.payment_gateway_id %></td>
                        <td>
                          <span class="status-badge <%= payment.status.downcase %>">
                            <%= payment.status %>
                          </span>
                        </td>
                        <td><%= payment.created_at.strftime("%b %d, %Y") %></td>
                        <td>
                          <%= link_to admin_payment_path(payment), class: "action-button view" do %>
                            <i class="fas fa-eye"></i>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              <div class="view-all-link">
                <%= link_to admin_payments_path(user_id: @user.id), class: "btn btn-secondary" do %>
                  View All Payments
                <% end %>
              </div>
            <% else %>
              <div class="no-data">No payments found for this user</div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabs = document.querySelectorAll('.tab');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Show corresponding tab content
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
      });
    });
  });
</script>

<style>
  /* User profile specific styles */
  .user-type-badge {
    margin-top: 5px;
  }
  
  .user-details-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .section-actions {
    display: flex;
    gap: 10px;
  }
  
  .btn-danger {
    background: #e63a52;
    color: white;
  }
  
  .btn-secondary {
    background: #666;
    color: white;
  }
  
  .api-credential {
    padding: 10px 0;
  }
  
  .api-divider {
    border: none;
    border-top: 1px dashed #eee;
    margin: 5px 0;
  }
  
  .status-badge.expired {
    background-color: #f0f0f0;
    color: #888;
  }
  
  .view-all-link {
    margin-top: 15px;
    text-align: center;
  }
</style> 